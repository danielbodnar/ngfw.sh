---
import PortalLayout from '../../layouts/PortalLayout.astro';

// Redirect to sign-in if not authenticated
const { userId } = Astro.locals.auth();\nif (!userId) {
  return Astro.redirect('/sign-in');
}
---

<PortalLayout title="QoS - NGFW.sh">
  <div class="space-y-6">
    <div>
      <h2 class="text-2xl font-semibold text-[--color-text-primary] mb-1">
        Quality of Service (QoS)
      </h2>
      <p class="text-[--color-text-secondary]">
        Manage traffic shaping and bandwidth prioritization
      </p>
    </div>

    <div id="qos-app"></div>
  </div>
</PortalLayout>

<script>
  import { createApp } from 'vue';
  import QoSRuleList from '../../components/services/QoSRuleList.vue';
  import QoSRuleForm from '../../components/services/QoSRuleForm.vue';
  import Card from '../../components/ui/Card.vue';
  import Input from '../../components/ui/Input.vue';
  import Toggle from '../../components/ui/Toggle.vue';
  import Button from '../../components/ui/Button.vue';

  // Mock data - will be replaced by composables
  const mockRules = [
    {
      id: '1',
      name: 'VoIP/Video Calls',
      enabled: true,
      priority: 1,
      protocol: 'udp',
      port: '5060-5061,3478-3497',
      class_type: 'high',
    },
    {
      id: '2',
      name: 'Gaming Traffic',
      enabled: true,
      priority: 2,
      destination: '0.0.0.0/0',
      protocol: 'udp',
      class_type: 'high',
    },
    {
      id: '3',
      name: 'Web Browsing',
      enabled: true,
      priority: 5,
      protocol: 'tcp',
      port: '80,443',
      class_type: 'medium',
    },
    {
      id: '4',
      name: 'Video Streaming',
      enabled: true,
      priority: 6,
      class_type: 'medium',
    },
    {
      id: '5',
      name: 'Guest Network Limit',
      enabled: true,
      priority: 10,
      source: '192.168.10.0/24',
      download_limit: 50,
      upload_limit: 10,
      class_type: 'custom',
    },
    {
      id: '6',
      name: 'Bulk Downloads',
      enabled: true,
      priority: 20,
      protocol: 'tcp',
      port: '20-21,873',
      class_type: 'low',
    },
  ];

  const mockGlobalConfig = {
    enabled: true,
    download_bandwidth: 1000,
    upload_bandwidth: 100,
  };

  const app = createApp({
    components: {
      QoSRuleList,
      QoSRuleForm,
      Card,
      Input,
      Toggle,
      Button,
    },
    data() {
      return {
        rules: mockRules,
        globalConfig: mockGlobalConfig,
        loading: false,
        ruleFormOpen: false,
        editingRule: null,
      };
    },
    methods: {
      handleAddRule() {
        this.editingRule = null;
        this.ruleFormOpen = true;
      },
      handleEditRule(rule) {
        this.editingRule = rule;
        this.ruleFormOpen = true;
      },
      handleDeleteRule(ruleId) {
        if (confirm('Are you sure you want to delete this QoS rule?')) {
          this.rules = this.rules.filter(r => r.id !== ruleId);
          alert('QoS rule deleted');
        }
      },
      handleToggleRule(ruleId, enabled) {
        const rule = this.rules.find(r => r.id === ruleId);
        if (rule) {
          rule.enabled = enabled;
        }
      },
      handleSaveRule(ruleData) {
        this.loading = true;
        console.log('Saving QoS rule:', ruleData);
        setTimeout(() => {
          if (this.editingRule) {
            const index = this.rules.findIndex(r => r.id === this.editingRule.id);
            if (index !== -1) {
              this.rules[index] = { ...this.rules[index], ...ruleData };
            }
          } else {
            const newRule = {
              ...ruleData,
              id: String(this.rules.length + 1),
            };
            this.rules.push(newRule);
          }
          this.loading = false;
          this.ruleFormOpen = false;
          this.editingRule = null;
          alert('QoS rule saved successfully');
        }, 1000);
      },
      handleSaveGlobalConfig() {
        this.loading = true;
        console.log('Saving global QoS config:', this.globalConfig);
        setTimeout(() => {
          this.loading = false;
          alert('QoS configuration saved');
        }, 1000);
      },
    },
    template: `
      <div class="space-y-6">
        <Card title="Global QoS Settings">
          <div class="space-y-4">
            <Toggle
              v-model="globalConfig.enabled"
              label="Enable QoS Traffic Shaping"
            />
            <div class="grid grid-cols-2 gap-4">
              <Input
                v-model="globalConfig.download_bandwidth"
                label="Total Download Bandwidth (Mbps)"
                type="number"
                placeholder="1000"
                :disabled="!globalConfig.enabled"
                help="Your ISP download speed"
              />
              <Input
                v-model="globalConfig.upload_bandwidth"
                label="Total Upload Bandwidth (Mbps)"
                type="number"
                placeholder="100"
                :disabled="!globalConfig.enabled"
                help="Your ISP upload speed"
              />
            </div>
            <div class="flex justify-end pt-4 border-t border-slate-200 dark:border-slate-800">
              <Button
                variant="primary"
                :disabled="!globalConfig.enabled || loading"
                @click="handleSaveGlobalConfig"
              >
                {{ loading ? 'Saving...' : 'Save Configuration' }}
              </Button>
            </div>
          </div>
        </Card>

        <QoSRuleList
          :rules="rules"
          :loading="false"
          @add="handleAddRule"
          @edit="handleEditRule"
          @delete="handleDeleteRule"
          @toggle="handleToggleRule"
        />

        <QoSRuleForm
          :is-open="ruleFormOpen"
          :rule="editingRule"
          :loading="loading"
          @close="ruleFormOpen = false"
          @save="handleSaveRule"
        />
      </div>
    `,
  });

  app.mount('#qos-app');
</script>
