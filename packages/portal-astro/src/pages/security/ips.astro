---
import PortalLayout from '../../layouts/PortalLayout.astro';
import IPSConfig from '../../components/security/IPSConfig.vue';
import IPSRuleList from '../../components/security/IPSRuleList.vue';
import IPSAlertList from '../../components/security/IPSAlertList.vue';

// Redirect to sign-in if not authenticated
const { userId } = Astro.locals.auth();
if (!userId) {
  return Astro.redirect('/sign-in');
}
---

<PortalLayout title="IPS - NGFW.sh">
  <div class="space-y-6">
    <div>
      <h2 class="text-2xl font-semibold text-[--color-text-primary] mb-1">
        Intrusion Prevention System
      </h2>
      <p class="text-[--color-text-secondary]">
        Configure IPS rules and monitor security alerts
      </p>
    </div>

    <div id="ips-app"></div>
  </div>
</PortalLayout>

<script>
  import { createApp } from 'vue';
  import IPSConfig from '../../components/security/IPSConfig.vue';
  import IPSRuleList from '../../components/security/IPSRuleList.vue';
  import IPSAlertList from '../../components/security/IPSAlertList.vue';

  // Mock data - will be replaced by composables
  const mockConfig = {
    enabled: true,
    mode: 'prevent', // detect, prevent
    sensitivity: 'medium', // low, medium, high
    auto_update: true,
    block_on_threat: true,
  };

  const mockRules = [
    {
      id: '1',
      name: 'SQL Injection Detection',
      category: 'Web Attacks',
      severity: 'high',
      enabled: true,
      signatures: 157,
    },
    {
      id: '2',
      name: 'Port Scan Detection',
      category: 'Reconnaissance',
      severity: 'medium',
      enabled: true,
      signatures: 43,
    },
    {
      id: '3',
      name: 'Malware Communication',
      category: 'Malware',
      severity: 'critical',
      enabled: true,
      signatures: 892,
    },
  ];

  const mockAlerts = [
    {
      id: '1',
      timestamp: '2026-02-06T14:23:15Z',
      rule: 'SQL Injection Detection',
      severity: 'high',
      source_ip: '203.0.113.45',
      destination_ip: '192.168.1.50',
      action: 'blocked',
      details: 'Attempted SQL injection in HTTP POST request',
    },
    {
      id: '2',
      timestamp: '2026-02-06T14:15:32Z',
      rule: 'Port Scan Detection',
      severity: 'medium',
      source_ip: '198.51.100.23',
      destination_ip: '192.168.1.1',
      action: 'logged',
      details: 'Sequential port scan detected from external IP',
    },
  ];

  const App = {
    components: { IPSConfig, IPSRuleList, IPSAlertList },
    data() {
      return {
        config: mockConfig,
        rules: mockRules,
        alerts: mockAlerts,
      };
    },
    methods: {
      handleSaveConfig(newConfig) {
        this.config = newConfig;
        console.log('Saving IPS config:', newConfig);
        // TODO: Call API composable
      },
      handleToggleRule(ruleId) {
        const rule = this.rules.find(r => r.id === ruleId);
        if (rule) {
          rule.enabled = !rule.enabled;
          console.log('Toggled rule:', rule);
          // TODO: Call API composable
        }
      },
      handleDismissAlert(alertId) {
        this.alerts = this.alerts.filter(a => a.id !== alertId);
        console.log('Dismissed alert:', alertId);
        // TODO: Call API composable
      },
    },
    template: `
      <div class="space-y-6">
        <IPSConfig :config="config" @save="handleSaveConfig" />
        <IPSRuleList :rules="rules" @toggle="handleToggleRule" />
        <IPSAlertList :alerts="alerts" @dismiss="handleDismissAlert" />
      </div>
    `,
  };

  const app = createApp(App);
  app.mount('#ips-app');
</script>
