version: '3.8'

services:
  # Schema API (Cloudflare Workers via Miniflare)
  api:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ../../packages/schema:/app
      - ./fixtures:/fixtures
    environment:
      - NODE_ENV=test
      - DATABASE_URL=file:./test.db
      - CLERK_SECRET_KEY=test_key
    command: >
      sh -c "
        npm install &&
        npx wrangler dev --local --port 8787
      "
    ports:
      - "8787:8787"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8787/health"]
      interval: 5s
      timeout: 3s
      retries: 10

  # Portal Astro Frontend
  portal:
    image: oven/bun:1
    working_dir: /app
    volumes:
      - ../:/app
      - ./fixtures:/fixtures
    environment:
      - NODE_ENV=test
      - VITE_API_URL=http://api:8787
      - PUBLIC_CLERK_PUBLISHABLE_KEY=test_key
      - CLERK_SECRET_KEY=test_key
    command: >
      sh -c "
        bun install &&
        bun run dev --host 0.0.0.0 --port 4321
      "
    ports:
      - "4321:4321"
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4321"]
      interval: 5s
      timeout: 3s
      retries: 10

  # Test Runner
  tests:
    image: mcr.microsoft.com/playwright:v1.48.0-jammy
    working_dir: /app
    volumes:
      - ../:/app
      - ./results:/results
    environment:
      - BASE_URL=http://portal:4321
      - API_URL=http://api:8787
      - CI=true
    command: >
      sh -c "
        npm install &&
        npx playwright test --reporter=html --output=/results
      "
    depends_on:
      portal:
        condition: service_healthy
      api:
        condition: service_healthy

volumes:
  node_modules:
  playwright_cache:
