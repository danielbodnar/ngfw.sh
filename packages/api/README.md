# NGFW.sh API Server (Rust)

> **Status: Compiles Successfully**
>
> This Rust-based API server compiles with `workers-rs` v0.7.4 and is ready for deployment.

## Overview

This package contains a Rust implementation of the NGFW.sh API designed to run on Cloudflare Workers. It provides:

- RESTful API endpoints for router management (as defined in AGENTS.md)
- WebSocket RPC for real-time communication with router agents
- Authentication via Clerk JWT validation
- Storage via Cloudflare KV, D1, and R2

## Architecture

### Durable Objects

The `AgentConnection` Durable Object manages WebSocket connections with router agents using:
- Interior mutability (`RefCell`) for state management (required by workers-rs 0.7+)
- Hibernation API for efficient WebSocket handling
- Persistent state storage for device authentication

### Storage

- **KV**: Device registry, configurations, sessions, cache
- **D1**: User accounts, organizations, subscriptions, audit logs
- **R2**: Firmware images, configuration backups, generated reports

## Deployment Configuration

The `wrangler.toml` is configured with:

- **Route**: `api.ngfw.sh`
- **D1 Database**: `ngfw-db` (49752c13-9ae5-416d-9e69-bc34cc603c8d)
- **KV Namespaces**: DEVICES, CONFIGS, SESSIONS, CACHE
- **R2 Buckets**: ngfw-firmware, ngfw-backups, ngfw-reports
- **Durable Objects**: AgentConnection (for WebSocket handling)

## Related Package

The TypeScript schema package at `packages/schema` provides:

- OpenAPI documentation at `specs.ngfw.sh`
- Can be used alongside this API for documentation purposes

## Development

```bash
# Build
bun run build:api

# Local development
bun run dev:api

# Deploy
bun run deploy:api
```

## Note on Workers-rs 0.7+

This codebase was updated to work with `workers-rs` v0.7.4 which includes breaking changes from earlier versions:

- `DurableObject::fetch()` signature is now `&self` (not `&mut self`)
- Interior mutability via `RefCell` is used for state management
- WebSocket event handlers are generated by the `#[durable_object]` macro
