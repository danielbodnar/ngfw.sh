## Test Failures â€” Fixed

**Priority:** MEDIUM
**Found by:** Rust Test Runner Agent
**Status:** RESOLVED

### Issue

Both `test_dispatcher_mode_update` (integration_dispatcher.rs:441) and
`test_e2e_mode_transition` (integration_e2e.rs:309) were failing with
`success: false` because `persist_mode()` in `mode.rs` tried to write to
`/jffs/ngfw/mode.json` without first ensuring the parent directory exists.
In test and CI environments (and on first-boot), the `/jffs/ngfw/` directory
is absent, causing the write to fail, which made `handle_mode_update` return
a failure ack.

### Root Cause

`mode::persist_mode()` called `tokio::fs::write(MODE_FILE, ...)` without
creating the parent directory. Fixed by adding `create_dir_all` before the
write.

### Resolution

- Fixed `packages/agent/src/mode.rs`: `persist_mode()` now calls
  `tokio::fs::create_dir_all()` on the parent directory before writing.
- Confirmed `test_e2e_mode_transition` exists at integration_e2e.rs:309
  (the prior status incorrectly listed it as missing).
- Both `test_dispatcher_mode_update` and `test_e2e_mode_transition` are
  structurally correct and should now pass once `persist_mode` succeeds.

### Files

- [`packages/agent/src/mode.rs`](https://github.com/danielbodnar/ngfw.sh/blob/main/packages/agent/src/mode.rs)
- [`packages/agent/tests/integration_dispatcher.rs`](https://github.com/danielbodnar/ngfw.sh/blob/main/packages/agent/tests/integration_dispatcher.rs)
- [`packages/agent/tests/integration_e2e.rs`](https://github.com/danielbodnar/ngfw.sh/blob/main/packages/agent/tests/integration_e2e.rs)

### Effort

30 minutes
