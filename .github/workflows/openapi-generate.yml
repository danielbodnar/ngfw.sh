name: Validate OpenAPI Schema Types

on:
  push:
    branches: [main]
    paths:
      - 'packages/protocol/src/**'
      - 'packages/api/src/**'
  pull_request:
    paths:
      - 'packages/protocol/src/**'
      - 'packages/api/src/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-protocol:
    name: Validate Protocol Types
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/protocol

      - name: Check protocol compiles with all features
        working-directory: packages/protocol
        run: |
          echo "Checking default features..."
          cargo check
          
          echo "Checking js feature (WASM)..."
          cargo check --features js
          
          echo "Checking native feature..."
          cargo check --features native

      - name: Run protocol tests
        working-directory: packages/protocol
        run: cargo test --verbose

      - name: Verify ToSchema derives
        working-directory: packages/protocol
        run: |
          # Count ToSchema derives to ensure they're present
          TOSCHEMA_COUNT=$(grep -r "ToSchema" src/ | grep -c derive || echo "0")
          echo "Found $TOSCHEMA_COUNT ToSchema derives"
          
          if [[ "$TOSCHEMA_COUNT" -lt 30 ]]; then
            echo "Warning: Expected at least 30 ToSchema derives, found $TOSCHEMA_COUNT"
            echo "Ensure all public types have ToSchema derive"
            exit 1
          fi

      - name: Generate documentation
        working-directory: packages/protocol
        run: cargo doc --no-deps

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: protocol-docs
          path: packages/protocol/target/doc/
          retention-days: 7

  validate-api:
    name: Validate API Compiles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/api

      - name: Check API compiles for Workers (wasm32)
        working-directory: packages/api
        run: cargo check --target wasm32-unknown-unknown

      - name: Verify OpenAPI types are registered
        working-directory: packages/api
        run: |
          # Verify ApiDoc struct exists and references protocol types
          grep -q "pub struct ApiDoc" src/openapi.rs
          grep -q "ngfw_protocol::Device" src/openapi.rs
          grep -q "ngfw_protocol::RpcMessage" src/openapi.rs
          echo "OpenAPI types are properly registered"
